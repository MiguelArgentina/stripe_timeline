<%= turbo_frame_tag "details" do %>
  <h1>Timeline <%= @key %></h1>
  <%= turbo_stream_from "tx:#{Current.tenant.id}:#{@key}" %>

  <div id="timeline">
    <%= render partial: "transactions/events", locals: { events: @events, key: @key, verbose: params[:verbose].present? } %>
  </div>

  <div class="toolbar" style="display:flex; gap:.5rem; margin-bottom:.5rem;">
    <%= link_to "Clear tx details", clear_tx_details_path, data: { turbo_frame: "details" } %>
    <% if params[:verbose].present? %>
      • <%= link_to "Hide internal updates", transaction_path(key: @key), data: { turbo_frame: "details" } %>
    <% else %>
      • <%= link_to "Show all events", transaction_path(key: @key, verbose: 1), data: { turbo_frame: "details" } %>
    <% end %>
    • <%= link_to "Export CSV", export_transaction_path(key: @key), data: { turbo: false }, class: "btn" %>
  </div>

<% end %>

<% totals = TransactionTotals.new(@events) %>
<div class="totals" style="display:flex; gap:.75rem; margin:.5rem 0;">
  <span>Gross: <strong><%= money_cents(totals.gross,   @events.first&.payload.dig("data","object","currency") || "usd") %></strong></span>
  <span>Refunded: <strong>-<%= money_cents(totals.refunded, "usd") %></strong></span>
  <span>Held (dispute): <strong>-<%= money_cents(totals.held, "usd") %></strong></span>
  <span>Reinstated: <strong>+<%= money_cents(totals.reinstated, "usd") %></strong></span>
  <span>Net: <strong><%= money_cents(totals.net, "usd") %></strong></span>
</div>


<%= link_to root_path, class: "button" do %>
  <span>Back to Transactions</span>
<% end %>